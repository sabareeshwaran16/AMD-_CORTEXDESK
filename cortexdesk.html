<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CortexDesk - Local AI Workspace</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        
        /* Sidebar */
        .sidebar { position: fixed; left: 0; top: 0; width: 250px; height: 100vh; background: #2c3e50; color: white; padding: 20px; }
        .sidebar h1 { font-size: 20px; margin-bottom: 30px; }
        .sidebar nav a { display: block; padding: 12px; margin-bottom: 5px; color: white; text-decoration: none; border-radius: 5px; transition: all 0.3s; }
        .sidebar nav a:hover, .sidebar nav a.active { background: #34495e; }
        
        /* Main Content */
        .main { margin-left: 250px; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h2 { font-size: 24px; margin-bottom: 5px; }
        .header p { color: #7f8c8d; }
        
        /* Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h3 { font-size: 18px; margin-bottom: 15px; color: #2c3e50; }
        
        /* Upload Zone */
        .upload-zone { border: 2px dashed #3498db; padding: 40px; text-align: center; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .upload-zone:hover { background: #ecf0f1; }
        
        /* Forms */
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button:hover { background: #2980b9; }
        button.secondary { background: #95a5a6; }
        button.danger { background: #e74c3c; }
        button.success { background: #27ae60; }
        
        /* Task Items */
        .task-item { padding: 12px; border-left: 3px solid #3498db; margin-bottom: 8px; background: #f8f9fa; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .task-item:hover { background: #e9ecef; }
        .task-item.urgent { border-left-color: #e74c3c; }
        .task-item.high { border-left-color: #f39c12; }
        .task-item.pending { background: #fff3cd; border-left-color: #ffc107; }
        .task-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; color: #2c3e50; }
        .task-meta { font-size: 12px; color: #7f8c8d; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .task-full { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd; font-size: 13px; color: #555; }
        
        /* Status Badge */
        .badge { display: inline-block; padding: 4px 8px; border-radius: 3px; font-size: 12px; font-weight: bold; }
        .badge.idle { background: #2ecc71; color: white; }
        .badge.processing { background: #f39c12; color: white; }
        .badge.pending { background: #ffc107; color: black; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tabs button { background: none; border: none; padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tabs button.active { border-bottom-color: #3498db; color: #3498db; }
        
        /* Page Sections */
        .page { display: none; }
        .page.active { display: block; }
        
        /* Meeting Mode Toggle */
        .toggle { position: relative; display: inline-block; width: 60px; height: 34px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ecc71; }
        input:checked + .slider:before { transform: translateX(26px); }
        
        /* List */
        .list-item { padding: 10px; border-bottom: 1px solid #eee; }
        .list-item:hover { background: #f8f9fa; }
        
        /* Alert */
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .alert.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h1>üîí CortexDesk</h1>
        <nav>
            <a href="#" class="nav-link active" data-page="dashboard">üìä Dashboard</a>
            <a href="#" class="nav-link" data-page="tasks">‚úÖ Tasks</a>
            <a href="#" class="nav-link" data-page="meetings">üé§ Meetings</a>
            <a href="#" class="nav-link" data-page="research">üîç Research</a>
            <a href="#" class="nav-link" data-page="confirmations">‚è≥ Confirmations</a>
            <a href="#" class="nav-link" data-page="inbox">üì• Inbox</a>
            <a href="#" class="nav-link" data-page="settings">‚öôÔ∏è Settings</a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <div class="header">
                <h2>Dashboard</h2>
                <p>100% Offline | Privacy-First | No Cloud Calls</p>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>üìÑ Upload Document</h3>
                    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                        <p>Click to upload or drag & drop</p>
                        <p style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">PDF, DOCX, XLSX, TXT, PPTX, PNG, JPG (OCR)</p>
                    </div>
                    <input type="file" id="fileInput" style="display: none;" onchange="uploadFile()" accept=".pdf,.docx,.xlsx,.txt,.pptx,.png,.jpg,.jpeg,.bmp,.gif,.tiff">
                </div>

                <div class="card">
                    <h3>üì∏ Screen Capture OCR</h3>
                    <p style="margin-bottom: 15px;">Upload screenshot to extract text</p>
                    <div class="upload-zone" id="screenshotZone" onclick="document.getElementById('screenshotInput').click()" style="padding: 30px;">
                        <p>üì∑ Click to upload or drag & drop screenshot</p>
                        <p style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">PNG, JPG, BMP, GIF</p>
                    </div>
                    <input type="file" id="screenshotInput" style="display: none;" onchange="uploadScreenshot()" accept=".png,.jpg,.jpeg,.bmp,.gif">
                    <p style="font-size: 11px; color: #95a5a6; margin-top: 10px;">üí° Tip: Press Win+Shift+S to capture screen</p>
                </div>

                <div class="card">
                    <h3>üìù Manual Entry</h3>
                    <textarea id="manualText" rows="4" placeholder="Paste meeting notes, emails, or any text..."></textarea>
                    <button onclick="processManualText()">Process Text</button>
                </div>

                <div class="card">
                    <h3>üé§ Live Meeting Mode</h3>
                    <p style="margin-bottom: 15px;">Record and transcribe meetings in real-time</p>
                    <label class="toggle">
                        <input type="checkbox" id="meetingToggle" onchange="toggleMeeting()">
                        <span class="slider"></span>
                    </label>
                    <span id="meetingStatus" style="margin-left: 10px;">OFF</span>
                    <div id="liveTranscript" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; min-height: 60px; max-height: 150px; overflow-y: auto; display: none;">
                        <strong>Live Transcript:</strong>
                        <p id="transcriptText" style="margin-top: 5px; font-size: 13px; color: #555;"></p>
                    </div>
                </div>

                <div class="card">
                    <h3>üìä Quick Stats</h3>
                    <div id="stats">
                        <p>Pending Confirmations: <strong id="pendingCount">0</strong></p>
                        <p>Active Tasks: <strong id="taskCount">0</strong></p>
                        <p>Documents Processed: <strong id="docCount">0</strong></p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>ü§ñ Agent Status</h3>
                <div id="agentStatus">Loading...</div>
            </div>
        </div>

        <!-- Tasks Page -->
        <div id="tasks" class="page">
            <div class="header">
                <h2>Tasks</h2>
                <p>Manage your action items</p>
            </div>

            <div class="tabs">
                <button class="active" onclick="filterTasks('all')">All</button>
                <button onclick="filterTasks('urgent')">Urgent</button>
                <button onclick="filterTasks('high')">High</button>
                <button onclick="filterTasks('today')">Today</button>
            </div>

            <div class="card">
                <div id="taskList">No tasks yet.</div>
            </div>
        </div>

        <!-- Meetings Page -->
        <div id="meetings" class="page">
            <div class="header">
                <h2>Meetings</h2>
                <p>Meeting summaries and decisions</p>
            </div>

            <div class="card">
                <div id="meetingList">No meetings recorded.</div>
            </div>
        </div>

        <!-- Research Page -->
        <div id="research" class="page">
            <div class="header">
                <h2>Research Workspace</h2>
                <p>Semantic search over your documents</p>
            </div>

            <div class="card">
                <h3>üîç Search Documents</h3>
                <input type="text" id="searchQuery" placeholder="Ask a question or search for information...">
                <button onclick="searchDocuments()">Search</button>
                <div id="searchResults" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Confirmations Page -->
        <div id="confirmations" class="page">
            <div class="header">
                <h2>Pending Confirmations</h2>
                <p>Review and approve AI-extracted items</p>
            </div>

            <div class="card">
                <div id="confirmationList">No pending confirmations.</div>
            </div>
        </div>

        <!-- Inbox Page -->
        <div id="inbox" class="page">
            <div class="header">
                <h2>Inbox</h2>
                <p>AI-detected items from all sources</p>
            </div>

            <div class="card">
                <div id="inboxList">Inbox is empty.</div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
            <div class="header">
                <h2>Settings</h2>
                <p>Configure your workspace</p>
            </div>

            <div class="card">
                <h3>üîí Privacy & Security</h3>
                <p>‚úÖ 100% Local Processing</p>
                <p>‚úÖ Encrypted Storage</p>
                <p>‚úÖ No Cloud Calls</p>
                <p>‚úÖ Offline-First</p>
            </div>

            <div class="card">
                <h3>‚öôÔ∏è System Info</h3>
                <div id="systemInfo">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8001';

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.dataset.page;
                
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                
                document.getElementById(page).classList.add('active');
                link.classList.add('active');
                
                loadPageData(page);
            });
        });

        // Upload File
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                showAlert('info', 'Uploading file...');
                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.ocr) {
                    showAlert('success', `‚úì OCR extracted ${data.text_length} characters from ${data.filename}`);
                } else {
                    showAlert('success', `File uploaded: ${data.filename}`);
                }
                
                setTimeout(() => {
                    loadStats();
                    loadConfirmations();
                }, 2000);
            } catch (error) {
                showAlert('error', 'Error uploading file: ' + error.message);
            }
        }

        // Upload Screenshot
        async function uploadScreenshot() {
            const fileInput = document.getElementById('screenshotInput');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                showAlert('info', 'üì∏ Processing screenshot with OCR...');
                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.status === 'error') {
                    showAlert('error', data.message);
                } else if (data.ocr) {
                    showAlert('success', `‚úì OCR extracted ${data.text_length} characters! Check Confirmations page.`);
                    setTimeout(() => {
                        loadStats();
                        loadConfirmations();
                    }, 2000);
                } else {
                    // Show installation guide
                    showAlert('error', 'OCR not available. See OCR_INSTALL_GUIDE.md for installation instructions.');
                    console.log('Install Tesseract from: https://github.com/UB-Mannheim/tesseract/wiki');
                }
            } catch (error) {
                showAlert('error', 'Error processing screenshot: ' + error.message);
            }
        }

        // Process Manual Text
        async function processManualText() {
            const textarea = document.getElementById('manualText');
            const text = textarea.value.trim();
            
            console.log('[Manual Entry] Starting process');
            console.log('[Manual Entry] Text length:', text.length);
            
            if (!text) {
                showAlert('error', 'Please enter some text');
                return;
            }

            showAlert('info', 'Processing text...');
            
            try {
                // Create FormData with text file
                const formData = new FormData();
                const blob = new Blob([text], { type: 'text/plain' });
                const timestamp = new Date().getTime();
                const filename = `manual_entry_${timestamp}.txt`;
                const file = new File([blob], filename, { type: 'text/plain' });
                formData.append('file', file);
                
                console.log('[Manual Entry] Uploading:', filename);

                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('[Manual Entry] Response status:', response.status);
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('[Manual Entry] Error response:', error);
                    throw new Error(error.detail || 'Upload failed');
                }
                
                const data = await response.json();
                console.log('[Manual Entry] Success:', data);
                showAlert('success', '‚úì Text processed successfully!');
                textarea.value = '';
                
                // Reload data after 3 seconds
                console.log('[Manual Entry] Waiting 3s before refresh');
                setTimeout(() => {
                    console.log('[Manual Entry] Refreshing data');
                    loadStats();
                    loadConfirmations();
                }, 3000);
            } catch (error) {
                console.error('[Manual Entry] Error:', error);
                showAlert('error', 'Error: ' + error.message);
            }
        }

        // Toggle Meeting Mode with Speech Recognition
        let meetingRecording = false;
        let meetingStartTime = null;
        let recognition = null;
        let meetingTranscript = '';
        
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showAlert('error', 'Speech recognition not supported in this browser. Use Chrome or Edge.');
                return null;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recog = new SpeechRecognition();
            recog.continuous = true;
            recog.interimResults = true;
            recog.lang = 'en-US';
            
            recog.onstart = () => {
                console.log('[Meeting] Speech recognition started');
                showAlert('info', 'üé§ Listening... Speak now!');
            };
            
            recog.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (finalTranscript) {
                    meetingTranscript += finalTranscript;
                    console.log('[Meeting] Captured:', finalTranscript);
                }
                
                // Update live display
                const transcriptDiv = document.getElementById('transcriptText');
                if (transcriptDiv) {
                    transcriptDiv.textContent = meetingTranscript + interimTranscript;
                    transcriptDiv.parentElement.scrollTop = transcriptDiv.parentElement.scrollHeight;
                }
            };
            
            recog.onerror = (event) => {
                console.error('[Meeting] Speech recognition error:', event.error);
                if (event.error === 'no-speech') {
                    console.log('[Meeting] No speech detected, continuing...');
                    showAlert('info', 'No speech detected. Keep speaking...');
                } else if (event.error === 'not-allowed') {
                    showAlert('error', 'Microphone access denied! Please allow microphone in browser settings.');
                    document.getElementById('meetingToggle').checked = false;
                    meetingRecording = false;
                } else if (event.error === 'network') {
                    showAlert('error', 'Network error. Speech recognition needs internet in some browsers.');
                } else {
                    showAlert('error', 'Speech error: ' + event.error);
                }
            };
            
            recog.onend = () => {
                if (meetingRecording) {
                    console.log('[Meeting] Recognition ended, restarting...');
                    recog.start();
                }
            };
            
            return recog;
        }
        
        function toggleMeeting() {
            const toggle = document.getElementById('meetingToggle');
            const status = document.getElementById('meetingStatus');
            
            meetingRecording = toggle.checked;
            
            if (meetingRecording) {
                // Start recording
                recognition = initSpeechRecognition();
                if (!recognition) {
                    toggle.checked = false;
                    return;
                }
                
                meetingTranscript = '';
                meetingStartTime = new Date();
                status.textContent = 'RECORDING';
                status.style.color = '#27ae60';
                status.style.fontWeight = 'bold';
                
                // Show transcript area
                document.getElementById('liveTranscript').style.display = 'block';
                document.getElementById('transcriptText').textContent = 'Listening...';
                
                try {
                    recognition.start();
                    showAlert('success', 'üé§ Meeting recording started - speak now!');
                    console.log('[Meeting] Recording started');
                    updateMeetingTimer();
                } catch (error) {
                    console.error('[Meeting] Failed to start:', error);
                    showAlert('error', 'Failed to start recording: ' + error.message);
                    toggle.checked = false;
                    meetingRecording = false;
                    document.getElementById('liveTranscript').style.display = 'none';
                }
            } else {
                // Stop recording
                if (recognition) {
                    recognition.stop();
                    recognition = null;
                }
                
                status.textContent = 'OFF';
                status.style.color = '#95a5a6';
                status.style.fontWeight = 'normal';
                
                // Hide transcript area
                document.getElementById('liveTranscript').style.display = 'none';
                
                if (meetingStartTime) {
                    const duration = Math.floor((new Date() - meetingStartTime) / 1000);
                    console.log('[Meeting] Stopped. Duration:', duration, 'Transcript length:', meetingTranscript.length);
                    showAlert('info', `Meeting stopped. Duration: ${duration}s`);
                    meetingStartTime = null;
                    
                    // Process the transcript
                    if (meetingTranscript.trim().length > 0) {
                        processMeetingTranscript();
                    } else {
                        showAlert('error', 'No speech detected. Make sure microphone is working and you granted permission.');
                    }
                }
            }
        }
        
        async function processMeetingTranscript() {
            console.log('[Meeting] Processing transcript:', meetingTranscript);
            showAlert('info', 'Processing meeting transcript...');
            
            const meetingData = {
                timestamp: new Date().toISOString(),
                duration: Math.floor((new Date() - meetingStartTime) / 1000),
                transcript: meetingTranscript,
                filename: `meeting_${new Date().getTime()}.txt`
            };
            
            try {
                const formData = new FormData();
                const blob = new Blob([meetingTranscript], { type: 'text/plain' });
                const file = new File([blob], meetingData.filename, { type: 'text/plain' });
                formData.append('file', file);
                
                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const data = await response.json();
                
                // Store meeting ONLY AFTER successful processing
                storeMeetingHistory(meetingData);
                
                showAlert('success', '‚úì Meeting saved and processed! Check Confirmations page for extracted tasks.');
                
                setTimeout(() => {
                    loadStats();
                    loadConfirmations();
                }, 2000);
            } catch (error) {
                console.error('[Meeting] Processing error:', error);
                showAlert('error', 'Error processing transcript: ' + error.message);
            }
        }
        
        function storeMeetingHistory(meeting) {
            let meetings = JSON.parse(localStorage.getItem('meetingHistory') || '[]');
            meetings.unshift(meeting); // Add to beginning
            if (meetings.length > 50) meetings = meetings.slice(0, 50); // Keep last 50
            localStorage.setItem('meetingHistory', JSON.stringify(meetings));
        }
        
        function updateMeetingTimer() {
            if (!meetingRecording) return;
            
            const status = document.getElementById('meetingStatus');
            const duration = Math.floor((new Date() - meetingStartTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            status.textContent = `RECORDING ${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            setTimeout(updateMeetingTimer, 1000);
        }

        // Search Documents
        async function searchDocuments() {
            const query = document.getElementById('searchQuery').value;
            console.log('[Search] Query:', query);
            
            if (!query) {
                showAlert('error', 'Please enter a search query');
                return;
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<p style="color: #7f8c8d;">Searching...</p>';

            try {
                console.log('[Search] Sending request to:', `${API_URL}/search`);
                const response = await fetch(`${API_URL}/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                
                console.log('[Search] Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[Search] Error response:', errorText);
                    throw new Error('Search failed: ' + response.status);
                }
                
                const data = await response.json();
                console.log('[Search] Results:', data);
                
                if (data.message) {
                    // Empty database message
                    resultsDiv.innerHTML = `
                        <div class="alert info">
                            ${data.message}<br>
                            <small>Go to Dashboard and upload documents or use Manual Entry.</small>
                        </div>
                    `;
                    return;
                }
                
                if (data.count === 0) {
                    resultsDiv.innerHTML = `
                        <div class="alert info">
                            No results found for: "${query}"<br>
                            <small>Make sure you've uploaded documents first.</small>
                        </div>
                    `;
                    return;
                }
                
                // Display results
                resultsDiv.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong>Found ${data.count} results for: "${query}"</strong>
                    </div>
                    ${data.results.map((result, index) => `
                        <div class="card" style="margin-bottom: 15px; border-left: 3px solid #3498db;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <strong style="color: #2c3e50;">Result ${index + 1}</strong>
                                <span class="badge" style="background: #3498db;">${Math.round(result.similarity * 100)}% match</span>
                            </div>
                            <div style="font-size: 13px; color: #555; margin-bottom: 8px; line-height: 1.6;">
                                ${result.text}
                            </div>
                            <div style="font-size: 11px; color: #7f8c8d;">
                                üìÑ Source: ${result.source.split('/').pop() || result.source.split('\\').pop() || 'Unknown'}
                            </div>
                        </div>
                    `).join('')}
                `;
                console.log('[Search] Results displayed successfully');
            } catch (error) {
                console.error('[Search] Error:', error);
                resultsDiv.innerHTML = `<p class="alert error">Search failed: ${error.message}</p>`;
            }
        }

        // Load Page Data
        function loadPageData(page) {
            switch(page) {
                case 'dashboard':
                    loadStats();
                    loadAgentStatus();
                    break;
                case 'tasks':
                    loadTasks();
                    break;
                case 'confirmations':
                    loadConfirmations();
                    break;
                case 'meetings':
                    loadMeetings();
                    break;
            }
        }

        // Load Stats
        async function loadStats() {
            try {
                const [tasks, confirmations] = await Promise.all([
                    fetch(`${API_URL}/tasks`).then(r => r.json()),
                    fetch(`${API_URL}/confirmations`).then(r => r.json())
                ]);
                
                document.getElementById('taskCount').textContent = tasks.count || 0;
                document.getElementById('pendingCount').textContent = confirmations.count || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load Tasks
        async function loadTasks() {
            try {
                const response = await fetch(`${API_URL}/tasks`);
                const data = await response.json();
                
                const taskList = document.getElementById('taskList');
                if (data.tasks.length === 0) {
                    taskList.innerHTML = '<p>No tasks found.</p>';
                    return;
                }

                taskList.innerHTML = data.tasks.map((task, index) => {
                    const taskText = task.task.length > 100 ? task.task.substring(0, 100) + '...' : task.task;
                    const showExpand = task.task.length > 100;
                    return `
                        <div class="task-item ${task.priority || 'normal'}" id="task-${index}">
                            <div onclick="toggleTask(${index})">
                                <div class="task-title">${taskText} ${showExpand ? '<span style="color: #3498db; font-size: 11px;">[click to expand]</span>' : ''}</div>
                                <div class="task-full" id="task-full-${index}">${task.task}</div>
                            </div>
                            <div class="task-meta">
                                <span>üë§ ${task.assignee || 'Unassigned'}</span>
                                <span>üéØ ${task.priority || 'normal'}</span>
                                ${task.deadline ? `<span>üìÖ ${task.deadline}</span>` : ''}
                                <button onclick="event.stopPropagation(); deleteTask(${index})" style="background: #e74c3c; padding: 4px 8px; font-size: 11px;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        // Load Confirmations
        async function loadConfirmations() {
            try {
                const response = await fetch(`${API_URL}/confirmations`);
                const data = await response.json();
                
                const list = document.getElementById('confirmationList');
                if (data.pending.length === 0) {
                    list.innerHTML = '<p>No pending confirmations.</p>';
                    return;
                }

                list.innerHTML = data.pending.map(item => {
                    const task = item.data.task || 'Item';
                    const shortTask = task.length > 100 ? task.substring(0, 100) + '...' : task;
                    const assignee = item.data.assignee || 'Unassigned';
                    const deadline = item.data.deadline || 'No deadline';
                    const confidence = Math.round(item.confidence * 100);
                    
                    return `
                    <div class="task-item pending" style="margin-bottom: 15px;">
                        <div class="task-title">${shortTask}</div>
                        <div class="task-meta" style="margin: 8px 0;">
                            <span>üë§ ${assignee}</span>
                            <span>üìÖ ${deadline}</span>
                            <span>üéØ ${confidence}% confidence</span>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="success" onclick="approveItem('${item.id}')" style="margin-right: 5px;">‚úì Approve</button>
                            <button class="danger" onclick="rejectItem('${item.id}')">‚úó Reject</button>
                        </div>
                    </div>
                `}).join('');
                
                document.getElementById('pendingCount').textContent = data.count;
            } catch (error) {
                console.error('Error loading confirmations:', error);
            }
        }

        // Approve Item
        async function approveItem(itemId) {
            try {
                await fetch(`${API_URL}/confirmations/${itemId}/approve`, { method: 'POST' });
                showAlert('success', 'Item approved!');
                loadConfirmations();
                loadTasks();
            } catch (error) {
                showAlert('error', 'Error approving item');
            }
        }

        // Reject Item
        async function rejectItem(itemId) {
            try {
                await fetch(`${API_URL}/confirmations/${itemId}/reject`, { method: 'POST' });
                showAlert('success', 'Item rejected');
                loadConfirmations();
            } catch (error) {
                showAlert('error', 'Error rejecting item');
            }
        }

        // Load Agent Status
        async function loadAgentStatus() {
            try {
                const response = await fetch(`${API_URL}/status`);
                const data = await response.json();
                
                const statusDiv = document.getElementById('agentStatus');
                statusDiv.innerHTML = Object.entries(data).map(([agent, status]) => `
                    <div class="list-item">
                        <strong>${agent.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong>
                        <span class="badge ${status}">${status}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Load Meetings
        async function loadMeetings() {
            const meetingList = document.getElementById('meetingList');
            
            // Get meetings from localStorage
            const meetings = JSON.parse(localStorage.getItem('meetingHistory') || '[]');
            
            if (meetings.length === 0) {
                meetingList.innerHTML = '<p>No meetings recorded yet. Use Live Meeting Mode to record a meeting.</p>';
                return;
            }
            
            meetingList.innerHTML = meetings.map((meeting, index) => {
                const date = new Date(meeting.timestamp);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                const duration = Math.floor(meeting.duration / 60) + 'm ' + (meeting.duration % 60) + 's';
                const preview = meeting.transcript.substring(0, 200) + (meeting.transcript.length > 200 ? '...' : '');
                
                return `
                    <div class="card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong style="font-size: 16px;">üé§ Meeting ${meetings.length - index}</strong>
                                <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                                    üìÖ ${dateStr} | ‚è±Ô∏è ${duration}
                                </div>
                            </div>
                            <button onclick="deleteMeeting(${index})" class="danger" style="padding: 5px 10px; font-size: 12px;">üóëÔ∏è Delete</button>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 13px; color: #555; max-height: 100px; overflow-y: auto;">
                            ${preview}
                        </div>
                        <button onclick="toggleFullTranscript(${index})" style="margin-top: 10px; padding: 5px 10px; font-size: 12px; background: #95a5a6;">
                            üëÅÔ∏è View Full Transcript
                        </button>
                        <div id="fullTranscript${index}" style="display: none; margin-top: 10px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; max-height: 300px; overflow-y: auto;">
                            ${meeting.transcript}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleFullTranscript(index) {
            const element = document.getElementById(`fullTranscript${index}`);
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        function deleteMeeting(index) {
            if (!confirm('Delete this meeting?')) return;
            
            let meetings = JSON.parse(localStorage.getItem('meetingHistory') || '[]');
            meetings.splice(index, 1);
            localStorage.setItem('meetingHistory', JSON.stringify(meetings));
            loadMeetings();
            showAlert('success', 'Meeting deleted');
        }

        // Filter Tasks
        function filterTasks(filter) {
            document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            loadTasks();
        }

        // Show Alert
        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            document.querySelector('.main').insertBefore(alert, document.querySelector('.main').firstChild);
            setTimeout(() => alert.remove(), 5000);
        }
        
        // Delete Task
        async function deleteTask(index) {
            if (!confirm('Delete this task?')) return;
            
            // Remove from UI immediately
            const taskElement = document.getElementById(`task-${index}`);
            if (taskElement) {
                taskElement.remove();
                showAlert('success', '‚úì Task deleted');
            }
            
            // Remove from backend
            try {
                const response = await fetch(`${API_URL}/tasks/${index}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadStats();
                }
            } catch (error) {
                console.error('Delete error:', error);
            }
        }
        
        // Toggle Task Full Text
        function toggleTask(index) {
            const fullText = document.getElementById(`task-full-${index}`);
            if (fullText) {
                fullText.style.display = fullText.style.display === 'block' ? 'none' : 'block';
            }
        }

        // Drag and Drop for Screenshot
        const screenshotZone = document.getElementById('screenshotZone');
        
        screenshotZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            screenshotZone.style.background = '#e3f2fd';
            screenshotZone.style.borderColor = '#2196f3';
        });
        
        screenshotZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            screenshotZone.style.background = '';
            screenshotZone.style.borderColor = '';
        });
        
        screenshotZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            screenshotZone.style.background = '';
            screenshotZone.style.borderColor = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                // Check if it's an image
                if (file.type.startsWith('image/')) {
                    const input = document.getElementById('screenshotInput');
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    input.files = dataTransfer.files;
                    uploadScreenshot();
                } else {
                    showAlert('error', 'Please drop an image file (PNG, JPG, BMP, GIF)');
                }
            }
        });
        
        // Drag and Drop for Document Upload
        const uploadZone = document.querySelector('.upload-zone');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.style.background = '#e3f2fd';
            uploadZone.style.borderColor = '#2196f3';
        });
        
        uploadZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.style.background = '';
            uploadZone.style.borderColor = '';
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.style.background = '';
            uploadZone.style.borderColor = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const input = document.getElementById('fileInput');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(files[0]);
                input.files = dataTransfer.files;
                uploadFile();
            }
        });

        // Initialize
        loadStats();
        loadAgentStatus();
        setInterval(loadStats, 10000);
        setInterval(loadAgentStatus, 5000);
    </script>
</body>
</html>
